<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Kampung Spirit QR Tracker</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 2rem auto;
      padding: 1rem;
    }
    h1 {
      text-align: center;
    }
    #userIDDisplay {
      text-align: center;
      margin-bottom: 1rem;
    }
    #reader {
      width: 300px;
      margin: 1rem auto;
    }
    .button {
      display: inline-block;
      padding: 0.8rem 1.2rem;
      font-size: 1rem;
      margin: 0.5rem;
      cursor: pointer;
    }
    #status {
      text-align: center;
      margin-top: 1rem;
      font-weight: bold;
    }
    #notificationBar {
      display: none;
      background: #ffeeba;
      padding: 1rem;
      border: 1px solid #f0ad4e;
      border-radius: 5px;
      margin-bottom: 1.5rem;
    }
    #completionMessage {
      display: none;
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      padding: 1rem;
      border-radius: 5px;
      margin-bottom: 1.5rem;
      text-align: center;
    }
    img.event-map {
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin: 1.5rem 0;
    }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import {
      getFirestore,
      doc,
      getDoc,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
    import { onSnapshot } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBr1EJyETcCoeGsytiP8miTBTzFPWNVkyU",
      authDomain: "digital-stamp-info-sgbitcraft.firebaseapp.com",
      projectId: "digital-stamp-info-sgbitcraft",
      storageBucket: "digital-stamp-info-sgbitcraft.firebasestorage.app",
      messagingSenderId: "1090982094050",
      appId: "1:1090982094050:web:63e5e7ec746c551f2abb",
      measurementId: "G-870QQ95KPG"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Announcement listener
    const notificationDocRef = doc(db, "announcements", "global");
    let lastMessage = null;
    onSnapshot(notificationDocRef, docSnap => {
      if (!docSnap.exists()) return;
      const data = docSnap.data();
      const message = data.message?.trim() || '';
      if (lastMessage !== null && message !== lastMessage) {
        window.location.reload();
      }
      lastMessage = message;
      const bar = document.getElementById('notificationBar');
      const text = document.getElementById('notificationText');
      if (message) {
        text.textContent = message;
        bar.style.display = 'block';
      } else {
        bar.style.display = 'none';
      }
    });

    // QR scanning
    let html5QrCode;
    let scanning = false;

    window.startScan = async function () {
      if (scanning) return;
      scanning = true;
      html5QrCode = new Html5Qrcode("reader");
      await html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        async decodedText => {
          try {
            const url = new URL(decodedText);
            const station = url.searchParams.get("station");
            const storedUserID = localStorage.getItem("huntUserID");
            if (!station || !storedUserID) {
              alert("Invalid QR code or missing user ID.");
              return;
            }
            const userDocRef = doc(db, "kampungspirit25", storedUserID);
            const userSnap = await getDoc(userDocRef);
            if (!userSnap.exists()) {
              alert("User not found.");
              return;
            }
            await updateDoc(userDocRef, {
              [`stationsCompleted.${station}`]: true
            });
            document.getElementById("status").textContent =
              `âœ… "${station}" marked as completed!`;
            // reload to update completion status
            setTimeout(() => window.location.reload(), 1000);
          } catch (err) {
            console.error("QR scan error:", err);
            alert("Failed to process QR code.");
          } finally {
            window.stopScan();
          }
        },
        errorMessage => {
          // ignore
        }
      );
    };

    window.stopScan = function () {
      if (!html5QrCode) return;
      html5QrCode.stop().then(() => {
        html5QrCode.clear();
        scanning = false;
      });
    };

    // On load: get userID, show it, check completion
    window.addEventListener('DOMContentLoaded', async () => {
      const params = new URLSearchParams(window.location.search);
      const userID = params.get('userID') || localStorage.getItem('huntUserID');
      if (!userID) {
        alert('No user ID found. Please register first.');
        window.location.href = 'index.html';
        return;
      }
      localStorage.setItem('huntUserID', userID);
      document.querySelector('#userIDDisplay span').textContent = userID;

      // Check completion
      try {
        const userDocRef = doc(db, "kampungspirit25", userID);
        const userSnap = await getDoc(userDocRef);
        if (userSnap.exists()) {
          const data = userSnap.data();
          const completedCount = Object.values(data.stationsCompleted || {})
            .filter(v => v).length;
          const totalCount = Object.keys(data.stationsCompleted || {}).length;
          if (completedCount === totalCount) {
            document.getElementById('completionMessage').style.display = 'block';
          }
        }
      } catch (e) {
        console.error('Error checking completion:', e);
      }
    });
  </script>
</head>

<body>
  <h1>Booth Completion Tracker</h1>
  <p id="userIDDisplay"><strong>Your ID:</strong> <span></span></p>
  <button class="button" onclick="navigator.clipboard.writeText(window.location.href)">
    IMPORTANT: Save Your Link to return your card
  </button>

  <div style="margin: 1.5rem 0;">
    <img src="./images/eventmap.jpeg" alt="Event Map" class="event-map" />
  </div>

  <div id="notificationBar">
    <strong>Notice:</strong> <span id="notificationText"></span>
  </div>

  <div id="completionMessage">
    ðŸŽ‰ Congratulations! You've completed all the stations!
  </div>

  <div id="reader"></div>
  <div style="text-align:center;">
    <button class="button" onclick="startScan()">Start Scanning</button>
    <button class="button" onclick="stopScan()">Stop Scanning</button>
  </div>
  <div id="status"></div>
</body>
</html>
