<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Kampung Spirit QR & Treasure Tracker</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 2rem auto;
      padding: 1rem;
    }
    h1 { text-align: center; }
    #userIDDisplay { text-align: center; margin-bottom: 1rem; }
    #notificationBar {
      display: none;
      background: #ffeeba;
      padding: 1rem;
      border: 1px solid #f0ad4e;
      border-radius: 5px;
      margin-bottom: 1.5rem;
    }
    #completionMessage {
      display: none;
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      padding: 1rem;
      border-radius: 5px;
      margin-bottom: 1.5rem;
      text-align: center;
    }
    .event-map {
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin: 1.5rem 0;
    }
    .block { margin-bottom: 2rem; }
    .block h2 {
      margin-bottom: 0.5rem;
      border-bottom: 1px solid #ccc;
      padding-bottom: 0.2rem;
    }
    .station {
      margin: 0.3rem 0;
      padding: 0.4rem;
      cursor: default;
    }
    .station.visited { text-decoration: line-through; color: #555; }
    .station.treasure::after {
      content: " üéÅ";
    }
    #reader { width: 300px; margin: 1rem auto; }
    .scan-buttons { text-align: center; margin: 1rem 0; }
    .scan-buttons button {
      padding: 0.8rem 1.2rem;
      font-size: 1rem;
      margin: 0.3rem;
      cursor: pointer;
    }
    #status { text-align: center; margin-top: 1rem; font-weight: bold; }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      updateDoc,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    // Firebase init
    const firebaseConfig = {
      apiKey: "AIzaSyBr1EJyETcCoeGsytiP8miTBTzFPWNVkyU",
      authDomain: "digital-stamp-info-sgbitcraft.firebaseapp.com",
      projectId: "digital-stamp-info-sgbitcraft",
      storageBucket: "digital-stamp-info-sgbitcraft.firebasestorage.app",
      messagingSenderId: "1090982094050",
      appId: "1:1090982094050:web:63e5e7ec746c551f2abb",
      measurementId: "G-870QQ95KPG"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Announcement listener
    const notifRef = doc(db, "announcements", "global");
    let lastMsg = null;
    onSnapshot(notifRef, snap => {
      if (!snap.exists()) return;
      const msg = (snap.data().message || "").trim();
      if (lastMsg !== null && msg !== lastMsg) window.location.reload();
      lastMsg = msg;
      const bar = document.getElementById("notificationBar");
      if (msg) {
        document.getElementById("notificationText").textContent = msg;
        bar.style.display = "block";
      } else {
        bar.style.display = "none";
      }
    });

    // Station groups
    const groupedStations = {
      "Blk 698 Booth": [
        "Care Booth",
        "S3 Booth",
        "NEA Booth",
        "RN Zone 5",
        "CCAC Booth",
        "Food Booth 1 Goreng Pisang",
        "Food Booth 2 Roti Prata",
        "Food Booth 3 Tutu Keh"
      ],
      "Blk 698B Booth": [
        "Smash the Cans",
        "Ring the Bottle",
        "Rubber Band Gun",
        "Hop Scotch"
      ],
      "Blk 698A Booth": [
        "C2E Booth",
        "Bouncy Castle"
      ]
    };
    const allStations = Object.values(groupedStations).flat();

    // QR scanner
    let html5QrCode, scanning = false;
    window.startScan = async () => {
      if (scanning) return;
      scanning = true;
      html5QrCode = new Html5Qrcode("reader");
      await html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        onScanSuccess,
        () => {}
      );
    };
    window.stopScan = () => {
      if (!html5QrCode) return;
      html5QrCode.stop().then(() => { html5QrCode.clear(); scanning = false; });
    };

    // Handle scan success
    async function onScanSuccess(decodedText) {
      try {
        const url = new URL(decodedText);
        const station = url.searchParams.get("station");
        const userID = localStorage.getItem("huntUserID");
        if (!station || !userID) {
          alert("Invalid QR or missing user ID.");
          return;
        }

        const userRef = doc(db, "kampungspirit25", userID);
        const snap = await getDoc(userRef);
        const data = snap.exists() ? snap.data() : {};

        // mark visited
        await updateDoc(userRef, { [`stationsCompleted.${station}`]: true });

        // check treasure
        const treasures = data.treasureStations || [];
        const foundTreasure = treasures.includes(station);

        document.getElementById("status").textContent =
          foundTreasure
            ? `üéâ You found a TREASURE at "${station}"!`
            : `‚úÖ "${station}" completed.`;

        markStationVisited(station);
        if (foundTreasure) markStationTreasure(station);
        checkAllDone(userRef);
      } catch (e) {
        console.error(e);
        alert("Error processing QR.");
      } finally {
        stopScan();
      }
    }

    // Render only statuses initially
    function renderStations(statuses = {}) {
      const container = document.getElementById("stationsContainer");
      container.innerHTML = "";
      let idx = 1;
      for (const [block, stations] of Object.entries(groupedStations)) {
        const blockDiv = document.createElement("div");
        blockDiv.className = "block";
        blockDiv.innerHTML = `<h2>${block}</h2>`;
        stations.forEach(key => {
          const el = document.createElement("div");
          el.textContent = `${idx}. ${key}`;
          el.id = `station-${key.replace(/\s+/g, "_")}`;
          el.className = "station" + (statuses[key] ? " visited" : "");
          blockDiv.appendChild(el);
          idx++;
        });
        container.appendChild(blockDiv);
      }
    }

    function markStationVisited(station) {
      document
        .getElementById(`station-${station.replace(/\s+/g, "_")}`)
        .classList.add("visited");
    }
    function markStationTreasure(station) {
      document
        .getElementById(`station-${station.replace(/\s+/g, "_")}`)
        .classList.add("treasure");
    }

    async function checkAllDone(userRef) {
      const snap = await getDoc(userRef);
      if (!snap.exists()) return;
      const done = Object.values(snap.data().stationsCompleted || {})
                       .filter(v => v).length;
      if (done === allStations.length) {
        document.getElementById("completionMessage").style.display = "block";
      }
    }

    function pickTreasureStations() {
      const copy = [...allStations];
      const picked = [];
      for (let i = 0; i < 5; i++) {
        const idx = Math.floor(Math.random() * copy.length);
        picked.push(copy.splice(idx, 1)[0]);
      }
      return picked;
    }

    // On load
    window.addEventListener("DOMContentLoaded", async () => {
      const params = new URLSearchParams(window.location.search);
      const userID = params.get("userID") || localStorage.getItem("huntUserID");
      if (!userID) {
        alert("No user ID‚Äîplease register.");
        window.location.href = "index.html";
        return;
      }
      localStorage.setItem("huntUserID", userID);
      document.querySelector("#userIDDisplay span").textContent = userID;

      const userRef = doc(db, "kampungspirit25", userID);
      const snap = await getDoc(userRef);
      const data = snap.exists() ? snap.data() : {};

      // assign treasures once
      let treasures = data.treasureStations;
      if (!Array.isArray(treasures) || treasures.length !== 5) {
        treasures = pickTreasureStations();
        await setDoc(userRef, { treasureStations: treasures }, { merge: true });
      }

      renderStations(data.stationsCompleted || {});
      checkAllDone(userRef);
    });
  </script>
</head>

<body>
  <h1>Booth & Treasure Tracker</h1>
  <p id="userIDDisplay"><strong>Your ID:</strong> <span></span></p>
  <button onclick="navigator.clipboard.writeText(window.location.href)">
    IMPORTANT: Save Your Link to return your card
  </button>

  <div style="margin: 1.5rem 0;">
    <img src="./images/eventmap.jpeg" alt="Event Map" class="event-map" />
  </div>

  <div id="notificationBar">
    <strong>Notice:</strong> <span id="notificationText"></span>
  </div>

  <div id="completionMessage">
    üéâ Congratulations! You've completed all the stations!
  </div>

  <div id="stationsContainer"></div>

  <div id="reader"></div>
  <div class="scan-buttons">
    <button onclick="startScan()">Start Scanning</button>
    <button onclick="stopScan()">Stop Scanning</button>
  </div>
  <div id="status"></div>
</body>
</html>
