<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Treasure Hunt Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: 2rem auto; }
    .hint { margin: 2em 0; border: 1px solid #ddd; padding: 1em; border-radius: 6px; display: flex; align-items: center; }
    .hint.complete { opacity: 0.6; }
    .hint img { width: 100px; height: 100px; object-fit: cover; margin-right: 1em; border-radius: 4px; }
    .hint-content { flex: 1; }
    .visit-btn { margin-left: 1em; padding: 0.5em 1em; }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC70g8YdB4FvcnfnnLvnQKnxZvR8kYziXM",
      authDomain: "heartland-se.firebaseapp.com",
      projectId: "heartland-se",
      storageBucket: "heartland-se.appspot.com",
      messagingSenderId: "517981430157",
      appId: "1:517981430157:web:944816b509428f859f9dc4",
      measurementId: "G-905K6LQJ3L"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.addEventListener('DOMContentLoaded', async () => {
      // --- Fetch or redirect if no userID ---
      const params = new URLSearchParams(window.location.search);
      const userID = params.get('userID') || localStorage.getItem('huntUserID');
      if (!userID) {
        alert('No user ID found. Please register first.');
        window.location.href = 'index.html';
        return;
      }
      localStorage.setItem('huntUserID', userID);
      document.querySelector('#userIDDisplay span').textContent = userID;

      // --- Load userData ---
      const userDocRef = doc(db, "kampungspirit25", userID);
      const userSnap = await getDoc(userDocRef);
      if (!userSnap.exists()) {
        alert('User data not found.');
        return;
      }
      const userData = userSnap.data();

      // --- Define each station (you can swap in real image URLs) ---
      const hints = [
        {
          key: 'Five Stones',
          text: 'ðŸŽ¯ Test your reflexes and old-school cool! Visit us beside the hall',
          imageUrl: './images/station1.jpg'
        },
        {
          key: 'Chapteh Champion Arena',
          text: 'ðŸ”¥ Can you kick it? Visit us near the entrance',
          imageUrl: './images/station2.jpg'
        },
        {
          key: 'Pick-Up Sticks',
          text: 'ðŸ’¥ Nerves of steel required! We are at the centre',
          imageUrl: './images/station3.jpg'
        },
        {
          key: 'Marble Game',
          text: 'ðŸŽ¯ Marble masters, assemble!',
          imageUrl: './images/station4.jpg'
        },
      ];

      // --- Render all hints ---
      const container = document.getElementById('hintsContainer');
      container.innerHTML = '';
      hints.forEach(({ key, text, imageUrl }) => {
        const done = !!userData.stationsCompleted?.[key];

        const wrapper = document.createElement('div');
        wrapper.className = 'hint' + (done ? ' complete' : '');
        wrapper.dataset.key = key;

        const img = document.createElement('img');
        img.src = imageUrl;
        img.alt = key;
        wrapper.appendChild(img);

        const content = document.createElement('div');
        content.className = 'hint-content';
        content.textContent = text;
        wrapper.appendChild(content);

        const btn = document.createElement('button');
        btn.className = 'visit-btn';
        btn.textContent = done ? 'Undo Visit' : 'I Visited';
        wrapper.appendChild(btn);

        btn.addEventListener('click', async () => {
          const newState = !wrapper.classList.contains('complete');
          const action = newState ? 'mark as visited' : 'undo visit';
          if (!confirm(`Are you sure you want to ${action}?`)) return;

          btn.disabled = true;
          btn.textContent = newState ? 'Savingâ€¦' : 'Revertingâ€¦';

          try {
            // update firestore
            await updateDoc(userDocRef, {
              [`stationsCompleted.${key}`]: newState
            });
            // update UI
            wrapper.classList.toggle('complete', newState);
            btn.textContent = newState ? 'Undo Visit' : 'I Visited';
          } catch (err) {
            console.error('Update failed', err);
            btn.textContent = newState ? 'I Visited' : 'Undo Visit';
          } finally {
            btn.disabled = false;
          }
        });

        container.appendChild(wrapper);
      });
    });
  </script>
</head>
<body>
  <h1>Heartland Treasure Hunt</h1>

  <p id="userIDDisplay"><strong>Your ID:</strong> <span></span></p>
  <button onclick="navigator.clipboard.writeText(window.location.href)">
    Copy Your Resume Link
  </button>

  <div id="hintsContainer">
    <!-- populated dynamically -->
  </div>
</body>
</html>
